#+Property: :exports results :results replace
#+STYLE: <link rel="stylesheet" type="text/css" href="./worg.css" />
#+OPTIONS: ^:nil num:nil
#+TITLE: suboptimal

#+BEGIN_SRC python :results output raw :exports results
import glob
import collections
import json
tags = collections.defaultdict(list)
jfiles = glob.glob('build/*.json')
for jfile in jfiles:
    with open(jfile) as j:
        d = json.load(j)
    for tag in d['tags'].split(','):
        tags[tag].append(d)
print 'Topics:',
print '[[file:./index.html][all]] (%s)' % len(jfiles),
for tag, posts in sorted(tags.items()):
    print '[[file:./%s.html][%s]] (%s)' % (tag, tag, len(posts)),
print
#+END_SRC

#+BEGIN_SRC python :results output raw :exports results
import os
import json
posts = os.environ.get('POSTS','').split()

for basename in posts:
    with open('build/%s.json' % basename) as j:
        props = json.load(j)

    print '* %(title)s' % props
    print 'Posted %(date)s ([[file:%(basename)s.html][single post]])' % props

    with open(props['body']) as h:
        print '#+BEGIN_HTML'
        print h.read()
        print '#+END_HTML'

    print 'Filed under *%(tags)s*' % props
#+END_SRC
